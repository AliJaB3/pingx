# خودکارسازی آمار مصرف (Scheduler)

## فرکانس
- هر ~۳۰ دقیقه اجرا می‌شود (سلیپ ۱۸۰۰ ثانیه در `scheduler.py`).

## چه چیزی همگام می‌شود؟
- برای همه خریدهای فعال (`active=1` و منقضی نشده) از 3x-ui آمار زیر خوانده می‌شود:
  - up / down / total
  - expiryTime
- نتایج در جدول `cache_usage` ذخیره می‌شود تا بدون نیاز به کلیک کاربر، هشدارها و نمایش آمار به‌روز باشد.

## هشدارها
- اگر مصرف بین ۸۰ تا ۸۳٪ باشد و قبلا هشدار ۸۰٪ ارسال نشده باشد، پیام هشدار برای کاربر ارسال می‌شود.
- هشدار انقضا ۳ و ۱ روز مانده برای خریدهای فعال ارسال می‌شود (در صورت عدم ارسال اخیر).

## عیب‌یابی
- لاگ سرویس (`systemctl status pingx-bot`) را بررسی کنید؛ خطاهای scheduler با logger `pingx.scheduler` ثبت می‌شود.
- در صورت تفاوت API 3x-ui، متد `get_client_stats` چند مسیر fallback دارد (`/panel/api`, `/api`, `/xui`). اگر همه شکست خورد، URL و احراز هویت پنل را بررسی کنید.
- اگر total روی صفر است ولی پلن حجمی است، مقدار GB در رکورد خرید به total تبدیل می‌شود.
