# تمدید و آپگرید اشتراک

## قانون فعلی
- **اگر کاربر روی همان inbound یک خرید فعال دارد** (active=1 و expiry خالی یا بزرگ‌تر از اکنون):
  - کلاینت جدید ساخته نمی‌شود.
  - همان کلاینت در 3x-ui به‌روزرسانی می‌شود: expiry به اندازه روزهای پلن جدید افزایش می‌یابد و ترافیک (total) به اندازه GB پلن جدید اضافه می‌شود.
  - `sub_id` و `sub_link` ثابت می‌مانند.
  - در دیتابیس یک رکورد خرید جدید برای تاریخچه ساخته می‌شود، رکورد قبلی inactive می‌شود و `superseded_by` پر می‌شود.
- **اگر اشتراک منقضی شده باشد** (expiry <= اکنون یا خرید فعال وجود نداشته باشد):
  - کلاینت جدید در 3x-ui ساخته می‌شود و لینک جدید تولید می‌شود.

> ترافیک 0 به معنی نامحدود است و در جمع ترافیک جدید لحاظ نمی‌شود.

## لینک و QR
- لینک سابسکریپشن با مقادیر `SUB_SCHEME`, `SUB_HOST`, `SUB_PORT`, `SUB_PATH` ساخته می‌شود.
- گزینه «لینک جدید/QR» در منوی کاربر subId را در صورت نیاز rotate می‌کند.

## نکات
- منطق فعال بودن در `get_active_purchase_for_inbound` است و expiry گذشته را غیر فعال در نظر می‌گیرد.
- برای چند inbound، فقط inbound فعال (`ACTIVE_INBOUND_ID`) در فروش کاربر استفاده می‌شود.
